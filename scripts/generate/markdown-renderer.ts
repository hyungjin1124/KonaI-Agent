/**
 * Markdown ë¬¸ì„œ ë Œë”ëŸ¬
 */

import * as fs from 'fs';
import * as path from 'path';
import { ScreenSpec, InputField, ButtonSpec, GridColumn, EventSpec } from '../../config/types.js';

export class MarkdownRenderer {
  /**
   * í™”ë©´ ëª…ì„¸ì„œë¥¼ Markdownìœ¼ë¡œ ë Œë”ë§
   */
  renderSpec(spec: ScreenSpec, screenshotPath?: string): string {
    const lines: string[] = [];

    // ì œëª©
    const screenName = spec.header.screenName || spec.header.screenId;
    lines.push(`# ${screenName}`);
    lines.push('');
    lines.push(`> í™”ë©´ ID: \`${spec.header.screenId}\` | ë²„ì „: \`${spec.header.version}\``);
    lines.push('');

    // ë¬¸ì„œ ì •ë³´
    lines.push('## ë¬¸ì„œ ì •ë³´');
    lines.push('');
    lines.push(`| í•­ëª© | ê°’ |`);
    lines.push(`|------|-----|`);
    lines.push(`| ì‘ì„±ì¼ | ${spec.header.createdAt} |`);
    lines.push(`| ì‘ì„±ì | ${spec.header.createdBy} |`);
    if (spec.header.updatedAt) {
      lines.push(`| ìˆ˜ì •ì¼ | ${spec.header.updatedAt} |`);
      lines.push(`| ìˆ˜ì •ì | ${spec.header.updatedBy || '-'} |`);
    }
    lines.push('');

    // ê°œìš”
    lines.push('## 1. í™”ë©´ ê°œìš”');
    lines.push('');
    lines.push(`**ì„¤ëª…:** ${spec.overview.description}`);
    lines.push('');

    if (spec.overview.accessPath) {
      lines.push(`**ì ‘ê·¼ ê²½ë¡œ:** ${spec.overview.accessPath}`);
      lines.push('');
    }

    if (spec.overview.businessRules) {
      lines.push(`**ì—…ë¬´ ê·œì¹™:** ${spec.overview.businessRules}`);
      lines.push('');
    }

    if (spec.overview.relatedScreens && spec.overview.relatedScreens.length > 0) {
      lines.push('### ê´€ë ¨ í™”ë©´');
      lines.push('');
      for (const related of spec.overview.relatedScreens) {
        lines.push(`- \`${related.screenId}\`: ${related.screenName} (${related.relationship})`);
      }
      lines.push('');
    }

    // ìŠ¤í¬ë¦°ìƒ·
    if (screenshotPath) {
      lines.push('## 2. í™”ë©´ ë ˆì´ì•„ì›ƒ');
      lines.push('');
      const relativePath = screenshotPath.startsWith('/') ? screenshotPath : `./${screenshotPath}`;
      lines.push(`![${screenName}](${relativePath})`);
      lines.push('');
    }

    // ì…ë ¥ í•­ëª©
    if (spec.inputFields && spec.inputFields.length > 0) {
      lines.push('## 3. ì…ë ¥ í•­ëª© ì •ì˜');
      lines.push('');
      lines.push(this.renderInputFieldsTable(spec.inputFields));
      lines.push('');
    }

    // ë²„íŠ¼
    if (spec.buttons && spec.buttons.length > 0) {
      lines.push('## 4. ë²„íŠ¼/ì•¡ì…˜ ì •ì˜');
      lines.push('');
      lines.push(this.renderButtonsTable(spec.buttons));
      lines.push('');
    }

    // ê·¸ë¦¬ë“œ ì»¬ëŸ¼
    if (spec.gridColumns && spec.gridColumns.length > 0) {
      lines.push('## 5. ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ì •ì˜');
      lines.push('');
      lines.push(this.renderGridColumnsTable(spec.gridColumns));
      lines.push('');
    }

    // ì´ë²¤íŠ¸
    if (spec.events && spec.events.length > 0) {
      lines.push('## 6. ì´ë²¤íŠ¸ ì²˜ë¦¬');
      lines.push('');
      lines.push(this.renderEventsTable(spec.events));
      lines.push('');
    }

    // ë©”ì‹œì§€
    if (spec.messages && spec.messages.length > 0) {
      lines.push('## 7. ë©”ì‹œì§€ ì •ì˜');
      lines.push('');
      lines.push(this.renderMessagesTable(spec.messages));
      lines.push('');
    }

    // ë³€ê²½ ì´ë ¥
    if (spec.changeHistory && spec.changeHistory.length > 0) {
      lines.push('## ë³€ê²½ ì´ë ¥');
      lines.push('');
      lines.push(this.renderChangeHistoryTable(spec.changeHistory));
      lines.push('');
    }

    // í‘¸í„°
    lines.push('---');
    lines.push('');
    lines.push(`*Generated by KonaI Pipeline at ${new Date().toISOString()}*`);

    return lines.join('\n');
  }

  /**
   * ì…ë ¥ í•­ëª© í…Œì´ë¸”
   */
  private renderInputFieldsTable(fields: InputField[]): string {
    const lines: string[] = [];
    lines.push('| í•„ë“œëª… | í•„ë“œID | íƒ€ì… | ê¸¸ì´ | í•„ìˆ˜ | ì„¤ëª… |');
    lines.push('|--------|--------|------|------|------|------|');

    for (const field of fields) {
      const required = field.required ? '**Y**' : 'N';
      lines.push(
        `| ${field.fieldName} | \`${field.fieldId || '-'}\` | ${field.dataType} | ${field.length || '-'} | ${required} | ${field.remarks || '-'} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ë²„íŠ¼ í…Œì´ë¸”
   */
  private renderButtonsTable(buttons: ButtonSpec[]): string {
    const lines: string[] = [];
    lines.push('| ë²„íŠ¼ëª… | ID | ì´ë²¤íŠ¸ | ì²˜ë¦¬ ë‚´ìš© | API |');
    lines.push('|--------|-----|--------|----------|-----|');

    for (const button of buttons) {
      const api = button.apiEndpoint
        ? `\`${button.httpMethod || 'POST'} ${button.apiEndpoint}\``
        : '-';
      lines.push(
        `| ${button.buttonName} | \`${button.buttonId || '-'}\` | ${button.eventType} | ${button.action} | ${api} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ê·¸ë¦¬ë“œ ì»¬ëŸ¼ í…Œì´ë¸”
   */
  private renderGridColumnsTable(columns: GridColumn[]): string {
    const lines: string[] = [];
    lines.push('| ì»¬ëŸ¼ëª… | ID | íƒ€ì… | ë„ˆë¹„ | ì •ë ¬ | ì •ë ¬ê°€ëŠ¥ | ë¹„ê³  |');
    lines.push('|--------|-----|------|------|------|---------|------|');

    for (const col of columns) {
      lines.push(
        `| ${col.columnName} | \`${col.columnId || '-'}\` | ${col.dataType} | ${col.width || 'auto'} | ${col.align} | ${col.sortable !== false ? 'Y' : 'N'} | ${col.remarks} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ì´ë²¤íŠ¸ í…Œì´ë¸”
   */
  private renderEventsTable(events: EventSpec[]): string {
    const lines: string[] = [];
    lines.push('| ì´ë²¤íŠ¸ëª… | ID | íŠ¸ë¦¬ê±° | ëŒ€ìƒ | ì²˜ë¦¬ ë‚´ìš© |');
    lines.push('|---------|-----|--------|------|----------|');

    for (const event of events) {
      lines.push(
        `| ${event.eventName} | \`${event.eventId}\` | ${event.triggerType} | ${event.targetId || '-'} | ${event.handler} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ë©”ì‹œì§€ í…Œì´ë¸”
   */
  private renderMessagesTable(
    messages: Array<{
      messageId: string;
      messageType: string;
      messageText: string;
      useCase?: string;
    }>
  ): string {
    const lines: string[] = [];
    lines.push('| ë©”ì‹œì§€ID | ìœ í˜• | ë‚´ìš© | ì‚¬ìš© ì‹œì  |');
    lines.push('|---------|------|------|----------|');

    for (const msg of messages) {
      const typeEmoji = this.getMessageTypeEmoji(msg.messageType);
      lines.push(
        `| \`${msg.messageId}\` | ${typeEmoji} ${msg.messageType} | ${msg.messageText} | ${msg.useCase || '-'} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ë³€ê²½ ì´ë ¥ í…Œì´ë¸”
   */
  private renderChangeHistoryTable(
    history: Array<{
      version: string;
      changedAt: string;
      changedBy: string;
      changeType: string;
      description: string;
    }>
  ): string {
    const lines: string[] = [];
    lines.push('| ë²„ì „ | ë³€ê²½ì¼ | ë³€ê²½ì | ìœ í˜• | ë‚´ìš© |');
    lines.push('|------|--------|--------|------|------|');

    for (const entry of history) {
      lines.push(
        `| ${entry.version} | ${entry.changedAt} | ${entry.changedBy} | ${entry.changeType} | ${entry.description} |`
      );
    }

    return lines.join('\n');
  }

  /**
   * ë©”ì‹œì§€ ìœ í˜•ë³„ ì´ëª¨ì§€
   */
  private getMessageTypeEmoji(type: string): string {
    const emojis: Record<string, string> = {
      info: 'â„¹ï¸',
      success: 'âœ…',
      warning: 'âš ï¸',
      error: 'âŒ',
      confirm: 'â“',
    };
    return emojis[type] || 'ğŸ“';
  }

  /**
   * íŒŒì¼ë¡œ ì €ì¥
   */
  saveToFile(content: string, outputPath: string): void {
    const dir = path.dirname(outputPath);

    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }

    fs.writeFileSync(outputPath, content, 'utf-8');
  }
}
